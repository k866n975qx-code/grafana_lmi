{
  "__inputs": [],
  "__requires": [
    { "type": "grafana", "id": "grafana", "name": "Grafana", "version": "10.0.0" }
  ],
  "annotations": { "list": [] },
  "editable": true,
  "graphTooltip": 0,
  "id": null,
  "panels": [
    {
      "id": 100,
      "type": "row",
      "title": "Latest Completed Month",
      "gridPos": { "x": 0, "y": 0, "w": 24, "h": 1 },
      "collapsed": false
    },
    {
      "id": 1,
      "type": "stat",
      "title": "Period",
      "gridPos": { "x": 0, "y": 1, "w": 4, "h": 5 },
      "datasource": { "type": "frser-sqlite-datasource", "uid": "lmi_sqlite" },
      "targets": [{ "refId": "A", "format": "table", "queryType": "table",
        "queryText": "SELECT period_start_date || ' -> ' || period_end_date AS value FROM snapshots WHERE period_type = 'MONTH' ORDER BY period_end_date DESC LIMIT 1;",
        "rawQueryText": "SELECT period_start_date || ' -> ' || period_end_date AS value FROM snapshots WHERE period_type = 'MONTH' ORDER BY period_end_date DESC LIMIT 1;"
      }],
      "options": { "colorMode": "none", "graphMode": "none", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "value", "values": false }, "textMode": "value", "wideLayout": true },
      "fieldConfig": { "defaults": {}, "overrides": [] }
    },
    {
      "id": 2,
      "type": "stat",
      "title": "MV Change",
      "gridPos": { "x": 4, "y": 1, "w": 4, "h": 5 },
      "datasource": { "type": "frser-sqlite-datasource", "uid": "lmi_sqlite" },
      "targets": [{ "refId": "A", "format": "table", "queryType": "table",
        "queryText": "SELECT CAST(json_extract(payload_json, '$.period_summary.totals.delta.total_market_value') AS REAL) AS value FROM snapshots WHERE period_type = 'MONTH' ORDER BY period_end_date DESC LIMIT 1;",
        "rawQueryText": "SELECT CAST(json_extract(payload_json, '$.period_summary.totals.delta.total_market_value') AS REAL) AS value FROM snapshots WHERE period_type = 'MONTH' ORDER BY period_end_date DESC LIMIT 1;"
      }],
      "options": { "colorMode": "value", "graphMode": "none", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "value", "values": false }, "textMode": "value_and_name" },
      "fieldConfig": { "defaults": { "unit": "currencyUSD", "decimals": 0, "thresholds": { "mode": "absolute", "steps": [{ "value": null, "color": "red" }, { "value": 0, "color": "green" }] } }, "overrides": [] }
    },
    {
      "id": 3,
      "type": "stat",
      "title": "TWR %",
      "gridPos": { "x": 8, "y": 1, "w": 4, "h": 5 },
      "datasource": { "type": "frser-sqlite-datasource", "uid": "lmi_sqlite" },
      "targets": [{ "refId": "A", "format": "table", "queryType": "table",
        "queryText": "SELECT CAST(json_extract(payload_json, '$.period_summary.performance.period.twr_period_pct') AS REAL) AS value FROM snapshots WHERE period_type = 'MONTH' ORDER BY period_end_date DESC LIMIT 1;",
        "rawQueryText": "SELECT CAST(json_extract(payload_json, '$.period_summary.performance.period.twr_period_pct') AS REAL) AS value FROM snapshots WHERE period_type = 'MONTH' ORDER BY period_end_date DESC LIMIT 1;"
      }],
      "options": { "colorMode": "value", "graphMode": "none", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "value", "values": false }, "textMode": "value_and_name" },
      "fieldConfig": { "defaults": { "unit": "percent", "decimals": 2, "thresholds": { "mode": "absolute", "steps": [{ "value": null, "color": "red" }, { "value": 0, "color": "green" }] } }, "overrides": [] }
    },
    {
      "id": 4,
      "type": "stat",
      "title": "Income Change",
      "gridPos": { "x": 12, "y": 1, "w": 4, "h": 5 },
      "datasource": { "type": "frser-sqlite-datasource", "uid": "lmi_sqlite" },
      "targets": [{ "refId": "A", "format": "table", "queryType": "table",
        "queryText": "WITH s AS (SELECT payload_json AS j FROM snapshots WHERE period_type='MONTH' ORDER BY period_end_date DESC LIMIT 1), idx AS (SELECT j, 0 AS fi, (json_array_length(j,'$.intervals')-1) AS li FROM s) SELECT CAST(json_extract(j, printf('$.intervals[%d].income.projected_monthly_income', li)) AS REAL) - CAST(json_extract(j, printf('$.intervals[%d].income.projected_monthly_income', fi)) AS REAL) AS value FROM idx;",
        "rawQueryText": "WITH s AS (SELECT payload_json AS j FROM snapshots WHERE period_type='MONTH' ORDER BY period_end_date DESC LIMIT 1), idx AS (SELECT j, 0 AS fi, (json_array_length(j,'$.intervals')-1) AS li FROM s) SELECT CAST(json_extract(j, printf('$.intervals[%d].income.projected_monthly_income', li)) AS REAL) - CAST(json_extract(j, printf('$.intervals[%d].income.projected_monthly_income', fi)) AS REAL) AS value FROM idx;"
      }],
      "options": { "colorMode": "value", "graphMode": "none", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "value", "values": false }, "textMode": "value_and_name" },
      "fieldConfig": { "defaults": { "unit": "currencyUSD", "decimals": 0, "thresholds": { "mode": "absolute", "steps": [{ "value": null, "color": "red" }, { "value": 0, "color": "green" }] } }, "overrides": [] }
    },
    {
      "id": 5,
      "type": "stat",
      "title": "Goal Progress Delta",
      "gridPos": { "x": 16, "y": 1, "w": 4, "h": 5 },
      "datasource": { "type": "frser-sqlite-datasource", "uid": "lmi_sqlite" },
      "targets": [{ "refId": "A", "format": "table", "queryType": "table",
        "queryText": "WITH s AS (SELECT payload_json AS j FROM snapshots WHERE period_type='MONTH' ORDER BY period_end_date DESC LIMIT 1), idx AS (SELECT j, 0 AS fi, (json_array_length(j,'$.intervals')-1) AS li FROM s) SELECT CAST(json_extract(j, printf('$.intervals[%d].goal_progress.progress_pct', li)) AS REAL) - CAST(json_extract(j, printf('$.intervals[%d].goal_progress.progress_pct', fi)) AS REAL) AS value FROM idx;",
        "rawQueryText": "WITH s AS (SELECT payload_json AS j FROM snapshots WHERE period_type='MONTH' ORDER BY period_end_date DESC LIMIT 1), idx AS (SELECT j, 0 AS fi, (json_array_length(j,'$.intervals')-1) AS li FROM s) SELECT CAST(json_extract(j, printf('$.intervals[%d].goal_progress.progress_pct', li)) AS REAL) - CAST(json_extract(j, printf('$.intervals[%d].goal_progress.progress_pct', fi)) AS REAL) AS value FROM idx;"
      }],
      "options": { "colorMode": "value", "graphMode": "none", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "value", "values": false }, "textMode": "value_and_name" },
      "fieldConfig": { "defaults": { "unit": "percent", "decimals": 2, "thresholds": { "mode": "absolute", "steps": [{ "value": null, "color": "red" }, { "value": 0, "color": "green" }] } }, "overrides": [] }
    },
    {
      "id": 6,
      "type": "stat",
      "title": "Holding Count Change",
      "gridPos": { "x": 20, "y": 1, "w": 4, "h": 5 },
      "datasource": { "type": "frser-sqlite-datasource", "uid": "lmi_sqlite" },
      "targets": [{ "refId": "A", "format": "table", "queryType": "table",
        "queryText": "SELECT CAST(json_extract(payload_json, '$.period_summary.composition.delta.holding_count') AS INTEGER) AS value FROM snapshots WHERE period_type = 'MONTH' ORDER BY period_end_date DESC LIMIT 1;",
        "rawQueryText": "SELECT CAST(json_extract(payload_json, '$.period_summary.composition.delta.holding_count') AS INTEGER) AS value FROM snapshots WHERE period_type = 'MONTH' ORDER BY period_end_date DESC LIMIT 1;"
      }],
      "fieldConfig": { "defaults": { "unit": "none", "decimals": 0 }, "overrides": [] }
    },
    {
      "id": 101,
      "type": "row",
      "title": "TWR Windows",
      "gridPos": { "x": 0, "y": 6, "w": 24, "h": 1 },
      "collapsed": false
    },
    {
      "id": 7,
      "type": "stat",
      "title": "TWR 1m (End)",
      "gridPos": { "x": 0, "y": 7, "w": 6, "h": 5 },
      "datasource": { "type": "frser-sqlite-datasource", "uid": "lmi_sqlite" },
      "targets": [{ "refId": "A", "format": "table", "queryType": "table",
        "queryText": "SELECT CAST(json_extract(payload_json, '$.period_summary.performance.twr_windows.twr_1m_pct_end') AS REAL) AS value FROM snapshots WHERE period_type = 'MONTH' ORDER BY period_end_date DESC LIMIT 1;",
        "rawQueryText": "SELECT CAST(json_extract(payload_json, '$.period_summary.performance.twr_windows.twr_1m_pct_end') AS REAL) AS value FROM snapshots WHERE period_type = 'MONTH' ORDER BY period_end_date DESC LIMIT 1;"
      }],
      "options": { "colorMode": "value", "graphMode": "none", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "value", "values": false }, "textMode": "value_and_name" },
      "fieldConfig": { "defaults": { "unit": "percent", "decimals": 2, "thresholds": { "mode": "absolute", "steps": [{ "value": null, "color": "red" }, { "value": 0, "color": "green" }] } }, "overrides": [] }
    },
    {
      "id": 8,
      "type": "stat",
      "title": "TWR 3m (End)",
      "gridPos": { "x": 6, "y": 7, "w": 6, "h": 5 },
      "datasource": { "type": "frser-sqlite-datasource", "uid": "lmi_sqlite" },
      "targets": [{ "refId": "A", "format": "table", "queryType": "table",
        "queryText": "SELECT CAST(json_extract(payload_json, '$.period_summary.performance.twr_windows.twr_3m_pct_end') AS REAL) AS value FROM snapshots WHERE period_type = 'MONTH' ORDER BY period_end_date DESC LIMIT 1;",
        "rawQueryText": "SELECT CAST(json_extract(payload_json, '$.period_summary.performance.twr_windows.twr_3m_pct_end') AS REAL) AS value FROM snapshots WHERE period_type = 'MONTH' ORDER BY period_end_date DESC LIMIT 1;"
      }],
      "options": { "colorMode": "value", "graphMode": "none", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "value", "values": false }, "textMode": "value_and_name" },
      "fieldConfig": { "defaults": { "unit": "percent", "decimals": 2, "thresholds": { "mode": "absolute", "steps": [{ "value": null, "color": "red" }, { "value": 0, "color": "green" }] } }, "overrides": [] }
    },
    {
      "id": 9,
      "type": "stat",
      "title": "TWR 6m (End)",
      "gridPos": { "x": 12, "y": 7, "w": 6, "h": 5 },
      "datasource": { "type": "frser-sqlite-datasource", "uid": "lmi_sqlite" },
      "targets": [{ "refId": "A", "format": "table", "queryType": "table",
        "queryText": "SELECT CAST(json_extract(payload_json, '$.period_summary.performance.twr_windows.twr_6m_pct_end') AS REAL) AS value FROM snapshots WHERE period_type = 'MONTH' ORDER BY period_end_date DESC LIMIT 1;",
        "rawQueryText": "SELECT CAST(json_extract(payload_json, '$.period_summary.performance.twr_windows.twr_6m_pct_end') AS REAL) AS value FROM snapshots WHERE period_type = 'MONTH' ORDER BY period_end_date DESC LIMIT 1;"
      }],
      "options": { "colorMode": "value", "graphMode": "none", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "value", "values": false }, "textMode": "value_and_name" },
      "fieldConfig": { "defaults": { "unit": "percent", "decimals": 2, "thresholds": { "mode": "absolute", "steps": [{ "value": null, "color": "red" }, { "value": 0, "color": "green" }] } }, "overrides": [] }
    },
    {
      "id": 10,
      "type": "stat",
      "title": "TWR 12m (End)",
      "gridPos": { "x": 18, "y": 7, "w": 6, "h": 5 },
      "datasource": { "type": "frser-sqlite-datasource", "uid": "lmi_sqlite" },
      "targets": [{ "refId": "A", "format": "table", "queryType": "table",
        "queryText": "SELECT CAST(json_extract(payload_json, '$.period_summary.performance.twr_windows.twr_12m_pct_end') AS REAL) AS value FROM snapshots WHERE period_type = 'MONTH' ORDER BY period_end_date DESC LIMIT 1;",
        "rawQueryText": "SELECT CAST(json_extract(payload_json, '$.period_summary.performance.twr_windows.twr_12m_pct_end') AS REAL) AS value FROM snapshots WHERE period_type = 'MONTH' ORDER BY period_end_date DESC LIMIT 1;"
      }],
      "options": { "colorMode": "value", "graphMode": "none", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "value", "values": false }, "textMode": "value_and_name" },
      "fieldConfig": { "defaults": { "unit": "percent", "decimals": 2, "thresholds": { "mode": "absolute", "steps": [{ "value": null, "color": "red" }, { "value": 0, "color": "green" }] } }, "overrides": [] }
    },
    {
      "id": 102,
      "type": "row",
      "title": "Income & Yield (Start / End / Delta)",
      "gridPos": { "x": 0, "y": 12, "w": 24, "h": 1 },
      "collapsed": false
    },
    {
      "id": 11,
      "type": "table",
      "title": "Income Metrics (Latest Completed Month)",
      "gridPos": { "x": 0, "y": 13, "w": 24, "h": 8 },
      "datasource": { "type": "frser-sqlite-datasource", "uid": "lmi_sqlite" },
      "targets": [{ "refId": "A", "format": "table", "queryType": "table",
        "queryText": "WITH s AS (SELECT payload_json AS j FROM snapshots WHERE period_type='MONTH' ORDER BY period_end_date DESC LIMIT 1), idx AS (SELECT j, 0 AS fi, (json_array_length(j,'$.intervals')-1) AS li FROM s) SELECT 'Monthly Income' AS metric, CAST(json_extract(j, printf('$.intervals[%d].income.projected_monthly_income', fi)) AS REAL) AS start_val, CAST(json_extract(j, printf('$.intervals[%d].income.projected_monthly_income', li)) AS REAL) AS end_val, CAST(json_extract(j, printf('$.intervals[%d].income.projected_monthly_income', li)) AS REAL) - CAST(json_extract(j, printf('$.intervals[%d].income.projected_monthly_income', fi)) AS REAL) AS delta FROM idx UNION ALL SELECT 'Forward 12m Income', CAST(json_extract(j, printf('$.intervals[%d].income.forward_12m_total', fi)) AS REAL), CAST(json_extract(j, printf('$.intervals[%d].income.forward_12m_total', li)) AS REAL), CAST(json_extract(j, printf('$.intervals[%d].income.forward_12m_total', li)) AS REAL) - CAST(json_extract(j, printf('$.intervals[%d].income.forward_12m_total', fi)) AS REAL) FROM idx UNION ALL SELECT 'Current Yield %', CAST(json_extract(j, printf('$.intervals[%d].income.portfolio_current_yield_pct', fi)) AS REAL), CAST(json_extract(j, printf('$.intervals[%d].income.portfolio_current_yield_pct', li)) AS REAL), CAST(json_extract(j, printf('$.intervals[%d].income.portfolio_current_yield_pct', li)) AS REAL) - CAST(json_extract(j, printf('$.intervals[%d].income.portfolio_current_yield_pct', fi)) AS REAL) FROM idx UNION ALL SELECT 'Yield on Cost %', CAST(json_extract(j, printf('$.intervals[%d].income.portfolio_yield_on_cost_pct', fi)) AS REAL), CAST(json_extract(j, printf('$.intervals[%d].income.portfolio_yield_on_cost_pct', li)) AS REAL), CAST(json_extract(j, printf('$.intervals[%d].income.portfolio_yield_on_cost_pct', li)) AS REAL) - CAST(json_extract(j, printf('$.intervals[%d].income.portfolio_yield_on_cost_pct', fi)) AS REAL) FROM idx;",
        "rawQueryText": "WITH s AS (SELECT payload_json AS j FROM snapshots WHERE period_type='MONTH' ORDER BY period_end_date DESC LIMIT 1), idx AS (SELECT j, 0 AS fi, (json_array_length(j,'$.intervals')-1) AS li FROM s) SELECT 'Monthly Income' AS metric, CAST(json_extract(j, printf('$.intervals[%d].income.projected_monthly_income', fi)) AS REAL) AS start_val, CAST(json_extract(j, printf('$.intervals[%d].income.projected_monthly_income', li)) AS REAL) AS end_val, CAST(json_extract(j, printf('$.intervals[%d].income.projected_monthly_income', li)) AS REAL) - CAST(json_extract(j, printf('$.intervals[%d].income.projected_monthly_income', fi)) AS REAL) AS delta FROM idx UNION ALL SELECT 'Forward 12m Income', CAST(json_extract(j, printf('$.intervals[%d].income.forward_12m_total', fi)) AS REAL), CAST(json_extract(j, printf('$.intervals[%d].income.forward_12m_total', li)) AS REAL), CAST(json_extract(j, printf('$.intervals[%d].income.forward_12m_total', li)) AS REAL) - CAST(json_extract(j, printf('$.intervals[%d].income.forward_12m_total', fi)) AS REAL) FROM idx UNION ALL SELECT 'Current Yield %', CAST(json_extract(j, printf('$.intervals[%d].income.portfolio_current_yield_pct', fi)) AS REAL), CAST(json_extract(j, printf('$.intervals[%d].income.portfolio_current_yield_pct', li)) AS REAL), CAST(json_extract(j, printf('$.intervals[%d].income.portfolio_current_yield_pct', li)) AS REAL) - CAST(json_extract(j, printf('$.intervals[%d].income.portfolio_current_yield_pct', fi)) AS REAL) FROM idx UNION ALL SELECT 'Yield on Cost %', CAST(json_extract(j, printf('$.intervals[%d].income.portfolio_yield_on_cost_pct', fi)) AS REAL), CAST(json_extract(j, printf('$.intervals[%d].income.portfolio_yield_on_cost_pct', li)) AS REAL), CAST(json_extract(j, printf('$.intervals[%d].income.portfolio_yield_on_cost_pct', li)) AS REAL) - CAST(json_extract(j, printf('$.intervals[%d].income.portfolio_yield_on_cost_pct', fi)) AS REAL) FROM idx;"
      }],
      "options": { "showHeader": true, "cellHeight": "md" },
      "fieldConfig": {
        "defaults": { "decimals": 2 },
        "overrides": [
          { "matcher": { "id": "byName", "options": "metric" }, "properties": [{ "id": "displayName", "value": "Metric" }] },
          { "matcher": { "id": "byName", "options": "start_val" }, "properties": [{ "id": "displayName", "value": "Start" }] },
          { "matcher": { "id": "byName", "options": "end_val" }, "properties": [{ "id": "displayName", "value": "End" }] },
          { "matcher": { "id": "byName", "options": "delta" }, "properties": [{ "id": "displayName", "value": "Delta" }] }
        ]
      }
    }
  ],
  "refresh": "2m",
  "schemaVersion": 39,
  "style": "dark",
  "tags": ["lmi", "periods"],
  "time": { "from": "now-90d", "to": "now" },
  "timezone": "browser",
  "title": "LMI - Period Performance",
  "uid": "lmi-period-performance",
  "version": 1
}
