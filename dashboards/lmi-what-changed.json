{
  "__inputs": [],
  "__requires": [{ "type": "grafana", "id": "grafana", "name": "Grafana", "version": "10.0.0" }],
  "annotations": { "list": [] },
  "editable": true,
  "graphTooltip": 0,
  "id": null,
  "panels": [
    {
      "id": 1,
      "type": "stat",
      "title": "Market Value Δ",
      "gridPos": { "x": 0, "y": 0, "w": 6, "h": 4 },
      "datasource": { "type": "frser-sqlite-datasource", "uid": "lmi_sqlite" },
      "targets": [
        { "refId": "A", "format": "table", "queryType": "table",
          "queryText": "WITH latest AS (SELECT payload_json j FROM snapshot_daily_current ORDER BY as_of_date_local DESC LIMIT 1), prev AS (SELECT payload_json j FROM snapshot_daily_current ORDER BY as_of_date_local DESC LIMIT 1 OFFSET 1) SELECT CAST(json_extract(latest.j,'$.totals.market_value') AS REAL) - CAST(json_extract(prev.j,'$.totals.market_value') AS REAL) AS value FROM latest, prev;",
          "rawQueryText": "WITH latest AS (SELECT payload_json j FROM snapshot_daily_current ORDER BY as_of_date_local DESC LIMIT 1), prev AS (SELECT payload_json j FROM snapshot_daily_current ORDER BY as_of_date_local DESC LIMIT 1 OFFSET 1) SELECT CAST(json_extract(latest.j,'$.totals.market_value') AS REAL) - CAST(json_extract(prev.j,'$.totals.market_value') AS REAL) AS value FROM latest, prev;"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "currencyUSD", "decimals": 0 }, "overrides": [] }
    },
    {
      "id": 2,
      "type": "stat",
      "title": "Projected Monthly Income Δ",
      "gridPos": { "x": 6, "y": 0, "w": 6, "h": 4 },
      "datasource": { "type": "frser-sqlite-datasource", "uid": "lmi_sqlite" },
      "targets": [
        { "refId": "A", "format": "table", "queryType": "table",
          "queryText": "WITH latest AS (SELECT payload_json j FROM snapshot_daily_current ORDER BY as_of_date_local DESC LIMIT 1), prev AS (SELECT payload_json j FROM snapshot_daily_current ORDER BY as_of_date_local DESC LIMIT 1 OFFSET 1) SELECT CAST(json_extract(latest.j,'$.income.projected_monthly_income') AS REAL) - CAST(json_extract(prev.j,'$.income.projected_monthly_income') AS REAL) AS value FROM latest, prev;",
          "rawQueryText": "WITH latest AS (SELECT payload_json j FROM snapshot_daily_current ORDER BY as_of_date_local DESC LIMIT 1), prev AS (SELECT payload_json j FROM snapshot_daily_current ORDER BY as_of_date_local DESC LIMIT 1 OFFSET 1) SELECT CAST(json_extract(latest.j,'$.income.projected_monthly_income') AS REAL) - CAST(json_extract(prev.j,'$.income.projected_monthly_income') AS REAL) AS value FROM latest, prev;"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "currencyUSD", "decimals": 2 }, "overrides": [] }
    },
    {
      "id": 3,
      "type": "stat",
      "title": "Forward 12m Income Δ",
      "gridPos": { "x": 12, "y": 0, "w": 6, "h": 4 },
      "datasource": { "type": "frser-sqlite-datasource", "uid": "lmi_sqlite" },
      "targets": [
        { "refId": "A", "format": "table", "queryType": "table",
          "queryText": "WITH latest AS (SELECT payload_json j FROM snapshot_daily_current ORDER BY as_of_date_local DESC LIMIT 1), prev AS (SELECT payload_json j FROM snapshot_daily_current ORDER BY as_of_date_local DESC LIMIT 1 OFFSET 1) SELECT CAST(json_extract(latest.j,'$.income.forward_12m_total') AS REAL) - CAST(json_extract(prev.j,'$.income.forward_12m_total') AS REAL) AS value FROM latest, prev;",
          "rawQueryText": "WITH latest AS (SELECT payload_json j FROM snapshot_daily_current ORDER BY as_of_date_local DESC LIMIT 1), prev AS (SELECT payload_json j FROM snapshot_daily_current ORDER BY as_of_date_local DESC LIMIT 1 OFFSET 1) SELECT CAST(json_extract(latest.j,'$.income.forward_12m_total') AS REAL) - CAST(json_extract(prev.j,'$.income.forward_12m_total') AS REAL) AS value FROM latest, prev;"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "currencyUSD", "decimals": 0 }, "overrides": [] }
    },
    {
      "id": 4,
      "type": "stat",
      "title": "LTV Δ",
      "gridPos": { "x": 18, "y": 0, "w": 6, "h": 4 },
      "datasource": { "type": "frser-sqlite-datasource", "uid": "lmi_sqlite" },
      "targets": [
        { "refId": "A", "format": "table", "queryType": "table",
          "queryText": "WITH latest AS (SELECT payload_json j FROM snapshot_daily_current ORDER BY as_of_date_local DESC LIMIT 1), prev AS (SELECT payload_json j FROM snapshot_daily_current ORDER BY as_of_date_local DESC LIMIT 1 OFFSET 1) SELECT CAST(json_extract(latest.j,'$.totals.margin_to_portfolio_pct') AS REAL) - CAST(json_extract(prev.j,'$.totals.margin_to_portfolio_pct') AS REAL) AS value FROM latest, prev;",
          "rawQueryText": "WITH latest AS (SELECT payload_json j FROM snapshot_daily_current ORDER BY as_of_date_local DESC LIMIT 1), prev AS (SELECT payload_json j FROM snapshot_daily_current ORDER BY as_of_date_local DESC LIMIT 1 OFFSET 1) SELECT CAST(json_extract(latest.j,'$.totals.margin_to_portfolio_pct') AS REAL) - CAST(json_extract(prev.j,'$.totals.margin_to_portfolio_pct') AS REAL) AS value FROM latest, prev;"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "percent", "decimals": 2 }, "overrides": [] }
    },
    {
      "id": 5,
      "type": "table",
      "title": "Holdings Changes (Latest vs Previous)",
      "gridPos": { "x": 0, "y": 4, "w": 24, "h": 12 },
      "datasource": { "type": "frser-sqlite-datasource", "uid": "lmi_sqlite" },
      "targets": [
        { "refId": "A", "format": "table", "queryType": "table",
          "queryText": "WITH latest_date AS (SELECT MAX(as_of_date_local) AS d FROM snapshot_daily_current),\nprev_date AS (SELECT MAX(as_of_date_local) AS d FROM snapshot_daily_current WHERE as_of_date_local < (SELECT d FROM latest_date)),\ncur AS (SELECT payload_json AS j FROM snapshot_daily_current WHERE as_of_date_local=(SELECT d FROM latest_date)),\nprev AS (SELECT payload_json AS j FROM snapshot_daily_current WHERE as_of_date_local=(SELECT d FROM prev_date)),\ncur_h AS (SELECT json_each.value AS v FROM cur, json_each(cur.j,'$.holdings')),\nprev_h AS (SELECT json_each.value AS v FROM prev, json_each(prev.j,'$.holdings'))\nSELECT\n  json_extract(c.v,'$.symbol') AS symbol,\n  (CAST(json_extract(c.v,'$.market_value') AS REAL) - CAST(json_extract(p.v,'$.market_value') AS REAL)) AS mv_delta,\n  (CAST(json_extract(c.v,'$.weight_pct') AS REAL) - CAST(json_extract(p.v,'$.weight_pct') AS REAL)) AS weight_delta,\n  (CAST(json_extract(c.v,'$.projected_monthly_dividend') AS REAL) - CAST(json_extract(p.v,'$.projected_monthly_dividend') AS REAL)) AS income_delta\nFROM cur_h c\nJOIN prev_h p ON json_extract(c.v,'$.symbol') = json_extract(p.v,'$.symbol')\nORDER BY abs(mv_delta) DESC;",
          "rawQueryText": "WITH latest_date AS (SELECT MAX(as_of_date_local) AS d FROM snapshot_daily_current),\nprev_date AS (SELECT MAX(as_of_date_local) AS d FROM snapshot_daily_current WHERE as_of_date_local < (SELECT d FROM latest_date)),\ncur AS (SELECT payload_json AS j FROM snapshot_daily_current WHERE as_of_date_local=(SELECT d FROM latest_date)),\nprev AS (SELECT payload_json AS j FROM snapshot_daily_current WHERE as_of_date_local=(SELECT d FROM prev_date)),\ncur_h AS (SELECT json_each.value AS v FROM cur, json_each(cur.j,'$.holdings')),\nprev_h AS (SELECT json_each.value AS v FROM prev, json_each(prev.j,'$.holdings'))\nSELECT\n  json_extract(c.v,'$.symbol') AS symbol,\n  (CAST(json_extract(c.v,'$.market_value') AS REAL) - CAST(json_extract(p.v,'$.market_value') AS REAL)) AS mv_delta,\n  (CAST(json_extract(c.v,'$.weight_pct') AS REAL) - CAST(json_extract(p.v,'$.weight_pct') AS REAL)) AS weight_delta,\n  (CAST(json_extract(c.v,'$.projected_monthly_dividend') AS REAL) - CAST(json_extract(p.v,'$.projected_monthly_dividend') AS REAL)) AS income_delta\nFROM cur_h c\nJOIN prev_h p ON json_extract(c.v,'$.symbol') = json_extract(p.v,'$.symbol')\nORDER BY abs(mv_delta) DESC;"
        }
      ],
      "options": { "showHeader": true, "cellHeight": "sm" },
      "fieldConfig": {
        "defaults": {},
        "overrides": [
          { "matcher": { "id": "byName", "options": "mv_delta" }, "properties": [ { "id": "unit", "value": "currencyUSD" }, { "id": "decimals", "value": 0 } ] },
          { "matcher": { "id": "byName", "options": "weight_delta" }, "properties": [ { "id": "unit", "value": "percent" }, { "id": "decimals", "value": 2 } ] },
          { "matcher": { "id": "byName", "options": "income_delta" }, "properties": [ { "id": "unit", "value": "currencyUSD" }, { "id": "decimals", "value": 2 } ] }
        ]
      }
    }
  ],
  "refresh": "30s",
  "schemaVersion": 39,
  "style": "dark",
  "tags": ["lmi"],
  "time": { "from": "now-90d", "to": "now" },
  "timezone": "browser",
  "title": "LMI - What Changed (Daily)",
  "uid": "lmi-what-changed",
  "version": 1
}
